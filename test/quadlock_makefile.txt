# Makefile pour Quadlock Encrypt
# Usage: make [target]

PYTHON = python3
VENV = quadlock_env
VENV_BIN = $(VENV)/bin
PIP = $(VENV_BIN)/pip
PYTHON_VENV = $(VENV_BIN)/python

.PHONY: help install test clean setup dev lint format security audit package docs

# Cible par dÃ©faut
help:
	@echo "ðŸ” Quadlock Encrypt - Makefile"
	@echo "=============================="
	@echo ""
	@echo "Cibles disponibles:"
	@echo "  install    - Installation complÃ¨te avec dÃ©pendances"
	@echo "  setup      - Configuration initiale (premiÃ¨re utilisation)"
	@echo "  test       - ExÃ©cution des tests complets"
	@echo "  dev        - Installation pour dÃ©veloppement"
	@echo "  clean      - Nettoyage des fichiers temporaires"
	@echo "  lint       - VÃ©rification du code (pylint, flake8)"
	@echo "  format     - Formatage automatique du code (black)"
	@echo "  security   - Audit de sÃ©curitÃ© (bandit)"
	@echo "  audit      - Audit des dÃ©pendances (pip-audit)"
	@echo "  package    - CrÃ©ation d'un package de distribution"
	@echo "  docs       - GÃ©nÃ©ration de la documentation"
	@echo "  benchmark  - Tests de performance"
	@echo ""
	@echo "Exemples:"
	@echo "  make install    # Installation complÃ¨te"
	@echo "  make test      # Tests rapides"
	@echo "  make clean     # Nettoyage"

# Installation complÃ¨te
install: $(VENV)/pyvenv.cfg
	@echo "ðŸ“¦ Installation des dÃ©pendances..."
	$(PIP) install --upgrade pip
	$(PIP) install -r requirements.txt
	@chmod +x *.sh
	@echo "âœ… Installation terminÃ©e!"

# CrÃ©ation de l'environnement virtuel
$(VENV)/pyvenv.cfg:
	@echo "ðŸ—ï¸  CrÃ©ation de l'environnement virtuel..."
	$(PYTHON) -m venv $(VENV)

# Configuration initiale
setup: install
	@echo "âš™ï¸  Configuration initiale..."
	$(PYTHON_VENV) quadlock_encrypt.py config --create
	@echo "ðŸ§ª ExÃ©cution du test initial..."
	@./test_quadlock.sh
	@echo "âœ… Configuration terminÃ©e!"

# Tests complets
test:
	@echo "ðŸ§ª ExÃ©cution des tests..."
	@./test_quadlock.sh
	@echo "ðŸ” Test d'intÃ©gritÃ©..."
	@./verify_integrity.sh
	@echo "ðŸ“Š Tests de performance basiques..."
	@$(PYTHON_VENV) -c "
import time
import secrets
from quadlock_encrypt import QuadlockApp
app = QuadlockApp()
data = secrets.token_bytes(1024*1024)  # 1MB
with open('test_perf.bin', 'wb') as f:
    f.write(data)
start = time.time()
app.encrypt_file('test_perf.bin', 'testpassword123')
encrypt_time = time.time() - start
print(f'â±ï¸  Chiffrement 1MB: {encrypt_time:.2f}s')
import os
os.remove('test_perf.bin')
if os.path.exists('test_perf.bin.qlk'):
    os.remove('test_perf.bin.qlk')
if os.path.exists('test_perf.bin.shares'):
    os.remove('test_perf.bin.shares')
"

# Installation pour dÃ©veloppement
dev: install
	$(PIP) install pylint flake8 black bandit pip-audit pytest coverage
	@echo "ðŸ› ï¸  Environnement de dÃ©veloppement prÃªt!"

# VÃ©rification du code
lint:
	@echo "ðŸ” Analyse statique du code..."
	$(VENV_BIN)/pylint quadlock_encrypt.py --disable=C0103,R0903,W0613 || true
	$(VENV_BIN)/flake8 quadlock_encrypt.py --max-line-length=100 --ignore=E203,W503 || true
	@echo "âœ… Analyse terminÃ©e!"

# Formatage du code
format:
	@echo "ðŸŽ¨ Formatage du code..."
	$(VENV_BIN)/black quadlock_encrypt.py --line-length=100
	@echo "âœ… Formatage terminÃ©!"

# Audit de sÃ©curitÃ©
security:
	@echo "ðŸ”’ Audit de sÃ©curitÃ© du code..."
	$(VENV_BIN)/bandit -r . -f json -o security_report.json || true
	$(VENV_BIN)/bandit -r . || true
	@echo "âœ… Audit de sÃ©curitÃ© terminÃ©!"

# Audit des dÃ©pendances
audit:
	@echo "ðŸ” Audit des dÃ©pendances..."
	$(VENV_BIN)/pip-audit --format=json --output=dependencies_audit.json || true
	$(VENV_BIN)/pip-audit || true
	@echo "âœ… Audit des dÃ©pendances terminÃ©!"

# Nettoyage
clean:
	@echo "ðŸ§¹ Nettoyage..."
	rm -rf __pycache__/
	rm -rf *.pyc
	rm -rf .pytest_cache/
	rm -rf build/
	rm -rf dist/
	rm -rf *.egg-info/
	rm -f test_*.txt test_*.qlk test_*.shares test_*_decrypted
	rm -f *.json.bak
	rm -f security_report.json dependencies_audit.json
	@echo "âœ… Nettoyage terminÃ©!"

# Nettoyage complet (inclut l'environnement virtuel)
distclean: clean
	rm -rf $(VENV)/
	@echo "ðŸ—‘ï¸  Nettoyage complet terminÃ©!"

# CrÃ©ation d'un package de distribution
package:
	@echo "ðŸ“¦ CrÃ©ation du package de distribution..."
	@mkdir -p dist/quadlock-encrypt
	@cp quadlock_encrypt.py dist/quadlock-encrypt/
	@cp *.sh dist/quadlock-encrypt/
	@cp requirements.txt dist/quadlock-encrypt/
	@cp default_config.json dist/quadlock-encrypt/
	@cp README.md dist/quadlock-encrypt/ 2>/dev/null || echo "README.md non trouvÃ©"
	@cp LICENSE dist/quadlock-encrypt/ 2>/dev/null || echo "LICENSE non trouvÃ©"
	@cd dist && tar -czf quadlock-encrypt-$(shell date +%Y%m%d).tar.gz quadlock-encrypt/
	@echo "âœ… Package crÃ©Ã©: dist/quadlock-encrypt-$(shell date +%Y%m%d).tar.gz"

# GÃ©nÃ©ration de la documentation
docs:
	@echo "ðŸ“š GÃ©nÃ©ration de la documentation..."
	@$(PYTHON_VENV) -c "
import quadlock_encrypt
import inspect
import json

# Extraction automatique de la documentation des fonctions
app = quadlock_encrypt.QuadlockApp()
crypto = quadlock_encrypt.QuadlockCrypto()

doc = {
    'QuadlockApp': {
        'methods': [method for method in dir(app) if not method.startswith('_')],
        'docstring': app.__class__.__doc__
    },
    'QuadlockCrypto': {
        'methods': [method for method in dir(crypto) if not method.startswith('_')],
        'docstring': crypto.__class__.__doc__
    }
}

with open('api_documentation.json', 'w') as f:
    json.dump(doc, f, indent=2)
    
print('ðŸ“„ Documentation API gÃ©nÃ©rÃ©e: api_documentation.json')
"

# Tests de performance
benchmark:
	@echo "âš¡ Tests de performance..."
	@$(PYTHON_VENV) -c "
import time
import secrets
import os
from quadlock_encrypt import QuadlockApp

app = QuadlockApp()
sizes = [1024, 10240, 102400, 1048576]  # 1KB, 10KB, 100KB, 1MB

print('ðŸ“Š Benchmarks de chiffrement:')
print('Taille\\t\\tChiffrement\\tDÃ©chiffrement')
print('-' * 50)

for size in sizes:
    # CrÃ©ation du fichier de test
    data = secrets.token_bytes(size)
    filename = f'bench_{size}.bin'
    with open(filename, 'wb') as f:
        f.write(data)
    
    # Test de chiffrement
    start = time.time()
    app.encrypt_file(filename, 'benchpassword123')
    encrypt_time = time.time() - start
    
    # Test de dÃ©chiffrement
    with open(filename + '.shares', 'r') as f:
        lines = f.readlines()
    shares = [line.split(': ')[1].strip() for line in lines if line.startswith('Part')][:3]
    
    start = time.time()
    app.decrypt_file(filename + '.qlk', shares)
    decrypt_time = time.time() - start
    
    # Formatage de la taille
    if size < 1